// prisma/schema.prisma
// Flatro — Полная актуальная схема БД
// Обновлено: Contracts V2 — расширенные договоры, вложения, польские требования

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============== ПОЛЬЗОВАТЕЛИ ==============

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  firstName String?
  lastName  String?
  phone     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Множественные роли
  isOwner  Boolean @default(false)
  isTenant Boolean @default(false)

  // Региональные настройки
  regionCode String @default("PL")
  language   String @default("pl")
  timezone   String @default("Europe/Warsaw")

  // Лицензионное соглашение
  termsAcceptedAt   DateTime?
  privacyAcceptedAt DateTime?
  termsVersion      String?

  // Банковские реквизиты (для владельцев)
  bankName      String?
  iban          String?
  accountHolder String?

  // Stripe Connect (для онлайн-платежей)
  stripeAccountId String?
  stripeOnboarded Boolean @default(false)

  // Связи для OWNER
  properties Property[]
  tenants    Tenant[]     @relation("OwnerTenants")
  payments   Payment[]

  // Связь для TENANT (жилец привязан к Tenant записи)
  tenantProfile Tenant? @relation("TenantUser")

  // Сообщения
  sentMessages     Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")

  // Заявки созданные (для жильцов)
  tickets Ticket[]

  // Объявления созданные (для владельцев)
  announcements Announcement[]

  @@map("users")
}

// ============== ПРИГЛАШЕНИЯ ==============

model Invitation {
  id         String           @id @default(uuid())
  propertyId String
  email      String?
  code       String           @unique
  status     InvitationStatus @default(PENDING)
  expiresAt  DateTime
  usedAt     DateTime?
  usedBy     String?
  createdAt  DateTime         @default(now())

  tenantId String?

  // Связи
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  // Индексы
  @@index([code])
  @@index([expiresAt])
  @@index([propertyId, status])
  @@map("invitations")
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

// ============== НЕДВИЖИМОСТЬ ==============

model Property {
  id          String         @id @default(uuid())
  userId      String
  name        String
  address     String
  city        String
  postalCode  String?
  country     String         @default("Poland")
  area        Float?
  rooms       Int?
  floor       Int?
  description String?
  status      PropertyStatus @default(VACANT)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // Связи
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenants          Tenant[]
  meters           Meter[]
  contracts        Contract[]
  invitations      Invitation[]
  messages         Message[]
  tickets          Ticket[]
  announcements    Announcement[]
  paymentTemplates PaymentTemplate[]

  // Индексы
  @@index([userId, status])
  @@map("properties")
}

enum PropertyStatus {
  VACANT
  OCCUPIED
  RESERVED
}

// ============== ЖИЛЬЦЫ ==============

model Tenant {
  id           String  @id @default(uuid())
  userId       String
  propertyId   String?
  tenantUserId String? @unique
  firstName    String
  lastName     String
  email        String?
  phone        String?

  // Универсальный национальный ID
  nationalId     String?
  nationalIdType String?

  // @deprecated — используйте nationalId + nationalIdType
  pesel String?

  // Региональные настройки
  regionCode String @default("PL")

  // Экстренный контакт
  emergencyContact String?
  emergencyPhone   String?

  // Польские требования (Contracts V2)
  citizenship         String? // Obywatelstwo
  registrationAddress String? // Adres zameldowania

  // Даты аренды
  moveInDate  DateTime?
  moveOutDate DateTime?
  isActive    Boolean   @default(true)

  // Лицензионное соглашение
  termsAcceptedAt         DateTime?
  termsVersion            String?
  registrationCompletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Связи
  user          User      @relation("OwnerTenants", fields: [userId], references: [id], onDelete: Cascade)
  tenantUser    User?     @relation("TenantUser", fields: [tenantUserId], references: [id], onDelete: SetNull)
  property      Property? @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  payments      Payment[]
  contracts     Contract[]
  meterReadings MeterReading[]

  // Индексы
  @@index([email])
  @@index([userId, isActive])
  @@index([tenantUserId])
  @@index([regionCode])
  @@map("tenants")
}

// ============== ДОГОВОРЫ (Contracts V2) ==============

model Contract {
  id         String       @id @default(uuid())
  propertyId String
  tenantId   String
  type       ContractType @default(STANDARD)
  startDate  DateTime
  endDate    DateTime?

  // Финансы: czynsz + opłaty + media
  rentAmount       Float                          // Czynsz najmu
  adminFee         Float          @default(0)     // Czynsz administracyjny
  utilitiesAdvance Float          @default(0)     // Zaliczka na media
  depositAmount    Float?
  paymentDay       Int            @default(10)    // 1-28

  // Статус и подпись
  status         ContractStatus @default(DRAFT)
  signedAt       DateTime?
  signedByTenant Boolean        @default(false)
  signedByOwner  Boolean        @default(false)

  // Источник: форма или загруженный PDF
  contractSource  String @default("FORM")         // "FORM" | "UPLOAD"
  contractFileUrl String?                          // URL загруженного PDF

  // Najem okazjonalny — lokal zastępczy
  substituteAddress    String?
  substituteCity       String?
  substitutePostalCode String?

  // Масштабирование
  currency String @default("PLN")
  country  String @default("PL")
  locale   String @default("pl-PL")

  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Связи
  property    Property             @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  tenant      Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  attachments ContractAttachment[]

  // Индексы
  @@index([status, endDate])
  @@index([propertyId, status])
  @@index([country])
  @@index([contractSource])
  @@map("contracts")
}

model ContractAttachment {
  id         String   @id @default(uuid())
  contractId String
  type       String   // "AKT_NOTARIALNY" | "ZGODA_WLASCICIELA" | "OTHER"
  label      String
  fileUrl    String
  fileName   String?
  fileSize   Int?
  mimeType   String?
  metadata   Json?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Связи
  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  // Индексы
  @@index([contractId])
  @@map("contract_attachments")
}

enum ContractType {
  STANDARD
  OCCASIONAL
  INSTITUTIONAL
}

enum ContractStatus {
  DRAFT
  PENDING_SIGNATURE
  SIGNED
  ACTIVE
  EXPIRED
  TERMINATED
}

// ============== ПЛАТЕЖИ ==============

model Payment {
  id          String        @id @default(uuid())
  userId      String
  tenantId    String
  amount      Float
  type        PaymentType
  status      PaymentStatus @default(PENDING)
  dueDate     DateTime
  paidDate    DateTime?
  period      String?
  notes       String?

  // Данные для подтверждения
  markedPaidAt    DateTime?
  confirmedAt     DateTime?
  rejectedAt      DateTime?
  rejectionReason String?

  // Stripe
  stripePaymentId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Связи
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Индексы
  @@index([status, dueDate])
  @@index([tenantId, status])
  @@index([userId, createdAt])
  @@map("payments")
}

enum PaymentType {
  RENT
  UTILITIES
  DEPOSIT
  OTHER
}

enum PaymentStatus {
  PENDING
  PENDING_CONFIRMATION
  PAID
  OVERDUE
  REJECTED
  CANCELLED
}

// ============== ШАБЛОНЫ ПЛАТЕЖЕЙ ==============

model PaymentTemplate {
  id            String      @id @default(uuid())
  propertyId    String
  tenantId      String
  amount        Float
  type          PaymentType
  dayOfMonth    Int         @default(1)
  dueDayOfMonth Int         @default(10)
  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Связи
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@map("payment_templates")
}

// ============== СООБЩЕНИЯ ==============

model Message {
  id         String    @id @default(uuid())
  senderId   String
  receiverId String
  propertyId String
  content    String
  isRead     Boolean   @default(false)
  readAt     DateTime?
  createdAt  DateTime  @default(now())

  // Связи
  sender   User     @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User     @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  // Индексы
  @@index([receiverId, isRead])
  @@index([propertyId, createdAt])
  @@map("messages")
}

// ============== ЗАЯВКИ (ТИКЕТЫ) ==============

model Ticket {
  id          String       @id @default(uuid())
  propertyId  String
  createdById String
  title       String
  description String
  status      TicketStatus @default(NEW)
  photos      String[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Связи
  property  Property        @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  createdBy User            @relation(fields: [createdById], references: [id], onDelete: Cascade)
  comments  TicketComment[]

  @@map("tickets")
}

enum TicketStatus {
  NEW
  IN_PROGRESS
  RESOLVED
  CLOSED
}

model TicketComment {
  id        String   @id @default(uuid())
  ticketId  String
  authorId  String
  content   String
  createdAt DateTime @default(now())

  // Связи
  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@map("ticket_comments")
}

// ============== ОБЪЯВЛЕНИЯ ==============

model Announcement {
  id          String    @id @default(uuid())
  propertyId  String
  createdById String
  title       String
  content     String
  eventDate   DateTime?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Связи
  property  Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  createdBy User     @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@map("announcements")
}

// ============== СЧЁТЧИКИ (MEDIA) ==============

model Meter {
  id           String         @id @default(uuid())
  propertyId   String
  type         MeterType
  meterNumber  String?
  unit         String
  pricePerUnit Float?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  // Связи
  property Property       @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  readings MeterReading[]

  @@map("meters")
}

enum MeterType {
  ELECTRICITY
  GAS
  WATER_COLD
  WATER_HOT
  HEATING
}

model MeterReading {
  id          String   @id @default(uuid())
  meterId     String
  tenantId    String?
  value       Float
  readingDate DateTime
  photoUrl    String?
  createdAt   DateTime @default(now())

  // Связи
  meter  Meter   @relation(fields: [meterId], references: [id], onDelete: Cascade)
  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: SetNull)

  @@map("meter_readings")
}
