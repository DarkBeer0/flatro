// prisma/schema.prisma
// Flatro — Полная актуальная схема БД
// Обновлено: Utilities V5 — Meters & Utilities Module (Rozliczenie mediów)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============== ПОЛЬЗОВАТЕЛИ ==============

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  firstName String?
  lastName  String?
  phone     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Множественные роли
  isOwner  Boolean @default(false)
  isTenant Boolean @default(false)

  // Региональные настройки
  regionCode String @default("PL")
  language   String @default("pl")
  timezone   String @default("Europe/Warsaw")

  // Лицензионное соглашение
  termsAcceptedAt   DateTime?
  privacyAcceptedAt DateTime?
  termsVersion      String?

  // V4: Адрес владельца (для договоров — §1 Dane Wynajmującego)
  address    String?
  city       String?
  postalCode String?

  // V4: PESEL / нац. ID владельца (для договоров)
  nationalId     String?
  nationalIdType String? @default("PESEL")

  // Банковские реквизиты (для владельцев)
  bankName      String?
  iban          String?
  accountHolder String?

  // Stripe Connect (для онлайн-платежей)
  stripeAccountId String?
  stripeOnboarded Boolean @default(false)

  // Связи для OWNER
  properties Property[]
  tenants    Tenant[]     @relation("OwnerTenants")
  payments   Payment[]

  // Связь для TENANT (жилец привязан к Tenant записи)
  tenantProfile Tenant? @relation("TenantUser")

  // Сообщения
  sentMessages     Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")

  // Заявки созданные (для жильцов)
  tickets Ticket[]

  // Объявления созданные (для владельцев)
  announcements Announcement[]

  @@map("users")
}

// ============== ПРИГЛАШЕНИЯ ==============

model Invitation {
  id         String           @id @default(uuid())
  propertyId String
  email      String?
  code       String           @unique
  status     InvitationStatus @default(PENDING)
  expiresAt  DateTime
  usedAt     DateTime?
  usedBy     String?
  createdAt  DateTime         @default(now())

  tenantId String?

  // Связи
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  // Индексы
  @@index([code])
  @@index([expiresAt])
  @@index([propertyId, status])
  @@map("invitations")
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

// ============== НЕДВИЖИМОСТЬ ==============

model Property {
  id          String         @id @default(uuid())
  userId      String
  name        String
  address     String
  city        String
  postalCode  String?
  country     String         @default("Poland")
  area        Float?
  rooms       Int?
  floor       Int?
  description String?
  status      PropertyStatus @default(VACANT)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // Связи
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenants          Tenant[]
  meters           Meter[]
  contracts        Contract[]
  invitations      Invitation[]
  messages         Message[]
  tickets          Ticket[]
  announcements    Announcement[]
  paymentTemplates PaymentTemplate[]

  // V5: Utilities Module — новые связи
  fixedUtilities FixedUtility[]
  utilityRates   UtilityRate[]
  settlements    UtilitySettlement[]
  ledgerEntries  TenantLedger[]

  // Индексы
  @@index([userId, status])
  @@map("properties")
}

enum PropertyStatus {
  VACANT
  OCCUPIED
  RESERVED
}

// ============== ЖИЛЬЦЫ ==============

model Tenant {
  id           String  @id @default(uuid())
  userId       String
  propertyId   String?
  tenantUserId String? @unique
  firstName    String
  lastName     String
  email        String?
  phone        String?

  // Универсальный национальный ID
  nationalId     String?
  nationalIdType String?

  // @deprecated — используйте nationalId + nationalIdType
  pesel String?

  // Региональные настройки
  regionCode String @default("PL")

  // Экстренный контакт
  emergencyContact String?
  emergencyPhone   String?

  // Польские требования (Contracts V2)
  citizenship         String? // Obywatelstwo
  registrationAddress String? // Adres zameldowania

  // Даты аренды
  moveInDate  DateTime?
  moveOutDate DateTime?
  isActive    Boolean   @default(true)

  // Лицензионное соглашение
  termsAcceptedAt         DateTime?
  termsVersion            String?
  registrationCompletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Связи
  user          User      @relation("OwnerTenants", fields: [userId], references: [id], onDelete: Cascade)
  tenantUser    User?     @relation("TenantUser", fields: [tenantUserId], references: [id], onDelete: SetNull)
  property      Property? @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  payments      Payment[]
  contracts     Contract[]
  meterReadings MeterReading[]

  // V5: Utilities Module — новые связи
  settlementShares SettlementShare[]
  ledgerEntries    TenantLedger[]

  // Индексы
  @@index([email])
  @@index([userId, isActive])
  @@index([tenantUserId])
  @@index([regionCode])
  @@map("tenants")
}

// ============== ДОГОВОРЫ (Contracts V4) ==============

model Contract {
  id         String       @id @default(uuid())
  propertyId String
  tenantId   String
  type       ContractType @default(STANDARD)
  startDate  DateTime
  endDate    DateTime?

  // Финансы: czynsz + opłaty + media
  rentAmount       Float                          // Czynsz najmu
  adminFee         Float          @default(0)     // Czynsz administracyjny
  utilitiesAdvance Float          @default(0)     // Залiczка на media
  depositAmount    Float?
  paymentDay       Int            @default(10)    // 1-28

  // Статус и подпись
  status         ContractStatus @default(DRAFT)
  signedAt       DateTime?
  signedByTenant Boolean        @default(false)
  signedByOwner  Boolean        @default(false)

  // V3: Таймстемпы подписей
  ownerSignedAt  DateTime? @map("owner_signed_at")
  tenantSignedAt DateTime? @map("tenant_signed_at")

  // V3: Отслеживание статуса
  statusUpdatedAt DateTime? @default(now()) @map("status_updated_at")
  statusUpdatedBy String?   @map("status_updated_by")

  // V4: Юридические поля
  noticePeriod    Int?    @default(1)   // Okres wypowiedzenia (мес.)
  additionalTerms String?               // Szczególne postanowienia

  // Источник: форма или загруженный PDF
  contractSource  String @default("FORM")
  contractFileUrl String?

  // Najem okazjonalny — lokal zastępczy
  substituteAddress    String?
  substituteCity       String?
  substitutePostalCode String?

  // Масштабирование
  currency String @default("PLN")
  country  String @default("PL")
  locale   String @default("pl-PL")

  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Связи
  property      Property               @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  tenant        Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  attachments   ContractAttachment[]
  statusHistory ContractStatusHistory[]

  // Индексы
  @@index([status, endDate])
  @@index([propertyId, status])
  @@index([tenantId])
  @@index([country])
  @@index([contractSource])
  @@map("contracts")
}

model ContractStatusHistory {
  id         String   @id @default(uuid())
  contractId String   @map("contract_id")
  oldStatus  String?  @map("old_status")
  newStatus  String   @map("new_status")
  changedBy  String   @map("changed_by")
  changedAt  DateTime @default(now()) @map("changed_at")
  reason     String?

  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([contractId, changedAt(sort: Desc)])
  @@index([changedBy])
  @@map("contract_status_history")
}

model ContractAttachment {
  id         String   @id @default(uuid())
  contractId String
  type       String
  label      String
  fileUrl    String
  fileName   String?
  fileSize   Int?
  mimeType   String?
  metadata   Json?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([contractId])
  @@map("contract_attachments")
}

enum ContractType {
  STANDARD
  OCCASIONAL
  INSTITUTIONAL
}

enum ContractStatus {
  DRAFT
  PENDING_SIGNATURE
  SIGNED
  ACTIVE
  EXPIRED
  TERMINATED
}

// ============== ПЛАТЕЖИ ==============

model Payment {
  id          String        @id @default(uuid())
  userId      String
  tenantId    String
  amount      Float
  type        PaymentType
  status      PaymentStatus @default(PENDING)
  dueDate     DateTime
  paidDate    DateTime?
  period      String?
  notes       String?

  markedPaidAt    DateTime?
  confirmedAt     DateTime?
  rejectedAt      DateTime?
  rejectionReason String?

  stripePaymentId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([status, dueDate])
  @@index([tenantId, status])
  @@index([userId, createdAt])
  @@map("payments")
}

enum PaymentType {
  RENT
  UTILITIES
  DEPOSIT
  OTHER
}

enum PaymentStatus {
  PENDING
  PENDING_CONFIRMATION
  PAID
  OVERDUE
  REJECTED
  CANCELLED
}

model PaymentTemplate {
  id            String      @id @default(uuid())
  propertyId    String
  tenantId      String
  amount        Float
  type          PaymentType
  dayOfMonth    Int         @default(1)
  dueDayOfMonth Int         @default(10)
  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@map("payment_templates")
}

// ============== СООБЩЕНИЯ ==============

model Message {
  id         String    @id @default(uuid())
  senderId   String
  receiverId String
  propertyId String
  content    String
  isRead     Boolean   @default(false)
  readAt     DateTime?
  createdAt  DateTime  @default(now())

  sender   User     @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User     @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([receiverId, isRead])
  @@index([propertyId, createdAt])
  @@map("messages")
}

// ============== ЗАЯВКИ ==============

model Ticket {
  id          String       @id @default(uuid())
  propertyId  String
  createdById String
  title       String
  description String
  status      TicketStatus @default(NEW)
  photos      String[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  property  Property        @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  createdBy User            @relation(fields: [createdById], references: [id], onDelete: Cascade)
  comments  TicketComment[]

  @@map("tickets")
}

enum TicketStatus {
  NEW
  IN_PROGRESS
  RESOLVED
  CLOSED
}

model TicketComment {
  id        String   @id @default(uuid())
  ticketId  String
  authorId  String
  content   String
  createdAt DateTime @default(now())

  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@map("ticket_comments")
}

// ============== ОБЪЯВЛЕНИЯ ==============

model Announcement {
  id          String    @id @default(uuid())
  propertyId  String
  createdById String
  title       String
  content     String
  eventDate   DateTime?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  property  Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  createdBy User     @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@map("announcements")
}

// ╔══════════════════════════════════════════════════════════════╗
// ║                                                              ║
// ║          V5: METERS & UTILITIES MODULE                       ║
// ║          (Rozliczenie mediów)                                ║
// ║                                                              ║
// ╚══════════════════════════════════════════════════════════════╝

// ============== СЧЁТЧИКИ (V5: Enhanced) ==============

model Meter {
  id           String      @id @default(uuid())
  propertyId   String
  type         MeterType
  meterNumber  String?
  serialNumber String?                          // V5: Серийный номер
  unit         String
  pricePerUnit Float?

  // V5: Lifecycle
  status      MeterStatus @default(ACTIVE)
  installDate DateTime?
  archiveDate DateTime?
  archiveNote String?

  // V5: Meter exchange chain (self-relation)
  replacedById String? @unique
  replacedBy   Meter?  @relation("MeterReplacement", fields: [replacedById], references: [id])
  replaces     Meter?  @relation("MeterReplacement")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  property        Property         @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  readings        MeterReading[]
  settlementItems SettlementItem[] // V5

  @@index([propertyId, status])
  @@index([propertyId, type])
  @@map("meters")
}

enum MeterType {
  ELECTRICITY
  GAS
  WATER_COLD
  WATER_HOT
  HEATING
}

enum MeterStatus {
  ACTIVE
  ARCHIVED
  DECOMMISSIONED
}

model MeterReading {
  id          String           @id @default(uuid())
  meterId     String
  tenantId    String?
  value       Float
  readingDate DateTime
  readingType MeterReadingType @default(REGULAR) // V5
  photoUrl    String?
  notes       String?                            // V5
  createdAt   DateTime         @default(now())

  meter  Meter   @relation(fields: [meterId], references: [id], onDelete: Cascade)
  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: SetNull)

  @@index([meterId, readingDate(sort: Desc)])
  @@index([readingType])
  @@map("meter_readings")
}

enum MeterReadingType {
  REGULAR
  INITIAL
  FINAL
  METER_EXCHANGE
}

// ============== V5: ФИКСИРОВАННЫЕ УСЛУГИ ==============

model FixedUtility {
  id          String           @id @default(uuid())
  propertyId  String
  type        FixedUtilityType
  name        String
  periodCost  Float
  splitMethod CostSplitMethod  @default(BY_DAYS)
  isPerPerson Boolean          @default(false)
  isActive    Boolean          @default(true)
  notes       String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  property Property         @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  items    SettlementItem[]

  @@index([propertyId, isActive])
  @@map("fixed_utilities")
}

enum FixedUtilityType {
  INTERNET
  GARBAGE
  ADMIN_FEE
  PARKING
  TV_CABLE
  SECURITY
  ELEVATOR
  OTHER
}

// ============== V5: ТАРИФЫ (история ставок) ==============

model UtilityRate {
  id            String    @id @default(uuid())
  propertyId    String
  meterType     MeterType
  pricePerUnit  Float
  effectiveFrom DateTime
  effectiveTo   DateTime?
  source        String?
  notes         String?
  createdAt     DateTime  @default(now())

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId, meterType, effectiveFrom(sort: Desc)])
  @@map("utility_rates")
}

// ============== V5: РОЗЛІЧЕННЯ (Settlements) ==============

model UtilitySettlement {
  id             String           @id @default(uuid())
  propertyId     String
  createdById    String
  periodStart    DateTime
  periodEnd      DateTime
  title          String?
  approach       BillingApproach  @default(MONTHLY)
  totalAmount    Float            @default(0)
  invoiceNumber  String?
  invoiceDate    DateTime?
  invoiceFileUrl String?
  status         SettlementStatus @default(DRAFT)
  finalizedAt    DateTime?
  voidedAt       DateTime?
  voidReason     String?
  notes          String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  property Property          @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  items    SettlementItem[]
  shares   SettlementShare[]

  @@index([propertyId, periodStart(sort: Desc)])
  @@index([status])
  @@map("utility_settlements")
}

enum SettlementStatus {
  DRAFT
  CALCULATED
  FINALIZED
  VOIDED
}

enum BillingApproach {
  MONTHLY
  QUARTERLY
  SEMI_ANNUAL
  ANNUAL
  ADVANCE_PAYMENT
}

// ============== V5: ПОЗИЦИИ РОЗЛІЧЕННЯ ==============

model SettlementItem {
  id             String          @id @default(uuid())
  settlementId   String
  meterId        String?
  fixedUtilityId String?
  utilityLabel   String
  unitLabel      String?
  prevReading    Float?
  currReading    Float?
  consumption    Float?
  snapshotRate   Float?          // Зафиксированная ставка на момент расчёта
  periodCost     Float?
  totalCost      Float
  splitMethod    CostSplitMethod @default(BY_DAYS)
  createdAt      DateTime        @default(now())

  settlement   UtilitySettlement @relation(fields: [settlementId], references: [id], onDelete: Cascade)
  meter        Meter?            @relation(fields: [meterId], references: [id], onDelete: SetNull)
  fixedUtility FixedUtility?     @relation(fields: [fixedUtilityId], references: [id], onDelete: SetNull)

  @@index([settlementId])
  @@map("settlement_items")
}

enum CostSplitMethod {
  BY_DAYS
  BY_PERSONS
  EQUAL
  MANUAL
}

// ============== V5: ДОЛЯ ЖИЛЬЦА ==============

model SettlementShare {
  id               String    @id @default(uuid())
  settlementId     String
  tenantId         String
  activeDays       Int
  totalDays        Int
  shareRatio       Float
  calculatedAmount Float
  adjustedAmount   Float?
  finalAmount      Float
  advancesPaid     Float     @default(0)
  balanceDue       Float     @default(0)
  isPaid           Boolean   @default(false)
  paidAt           DateTime?
  paymentId        String?
  notes            String?   // Видна жильцу
  ownerNotes       String?   // Скрыта от жильца
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  settlement UtilitySettlement @relation(fields: [settlementId], references: [id], onDelete: Cascade)
  tenant     Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([settlementId, tenantId])
  @@index([tenantId, createdAt(sort: Desc)])
  @@index([isPaid])
  @@map("settlement_shares")
}

// ============== V5: КНИГА САЛЬДО ==============

model TenantLedger {
  id           String          @id @default(uuid())
  tenantId     String
  propertyId   String
  entryType    LedgerEntryType
  amount       Float           // positive = долг, negative = кредит
  settlementId String?
  paymentId    String?
  description  String
  balanceAfter Float           // running total
  createdAt    DateTime        @default(now())

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([tenantId, createdAt(sort: Desc)])
  @@index([propertyId, tenantId])
  @@map("tenant_ledger")
}

enum LedgerEntryType {
  CHARGE
  ADVANCE_PAYMENT
  PAYMENT
  ADJUSTMENT
  CARRY_FORWARD
}
