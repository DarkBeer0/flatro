// prisma/schema.prisma
// Flatro — Полная актуальная схема БД
// Обновлено: добавлена поддержка регионов, лицензионное соглашение, расширенные данные tenant

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============== ПОЛЬЗОВАТЕЛИ ==============

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  phone     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Множественные роли
  isOwner  Boolean @default(false)
  isTenant Boolean @default(false)

  // НОВОЕ: Региональные настройки
  regionCode String  @default("PL") // "PL" | "UA" | "DE" | "CZ" | "SK" | "LT" | "LV" | "EE"
  language   String  @default("pl") // Язык интерфейса
  timezone   String  @default("Europe/Warsaw")

  // НОВОЕ: Лицензионное соглашение
  termsAcceptedAt   DateTime? // Когда принято соглашение
  privacyAcceptedAt DateTime? // Когда принята политика конфиденциальности
  termsVersion      String?   // Версия соглашения ("1.0", "1.1", etc.)

  // Банковские реквизиты (для владельцев)
  bankName      String?
  iban          String?
  accountHolder String?

  // Stripe Connect (для онлайн-платежей)
  stripeAccountId String?
  stripeOnboarded Boolean @default(false)

  // Связи для OWNER
  properties Property[]
  tenants    Tenant[]     @relation("OwnerTenants")
  payments   Payment[]

  // Связь для TENANT (жилец привязан к Tenant записи)
  tenantProfile Tenant? @relation("TenantUser")

  // Сообщения
  sentMessages     Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")

  // Заявки созданные (для жильцов)
  tickets Ticket[]

  // Объявления созданные (для владельцев)
  announcements Announcement[]

  @@map("users")
}

// ============== ПРИГЛАШЕНИЯ ==============

model Invitation {
  id         String           @id @default(uuid())
  propertyId String
  email      String?          // Опционально - можно пригласить конкретный email
  code       String           @unique
  status     InvitationStatus @default(PENDING) // НОВОЕ: статус приглашения
  expiresAt  DateTime
  usedAt     DateTime?
  usedBy     String?          // ID пользователя который использовал
  createdAt  DateTime         @default(now())

  // НОВОЕ: Связь с созданным tenant
  tenantId String? // ID tenant, созданного при принятии приглашения

  // Связи
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  // Индексы для производительности
  @@index([code])
  @@index([expiresAt])
  @@index([propertyId, status])
  @@map("invitations")
}

// НОВОЕ: Статус приглашения
enum InvitationStatus {
  PENDING  // Ожидает использования
  ACCEPTED // Принято
  EXPIRED  // Истекло
  REVOKED  // Отозвано владельцем
}

// ============== НЕДВИЖИМОСТЬ ==============

model Property {
  id          String         @id @default(uuid())
  userId      String
  name        String
  address     String
  city        String
  postalCode  String?
  country     String         @default("Poland") // НОВОЕ: страна для определения региона
  area        Float?
  rooms       Int?
  floor       Int?
  description String?
  status      PropertyStatus @default(VACANT)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // Связи
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenants          Tenant[]
  meters           Meter[]
  contracts        Contract[]
  invitations      Invitation[]
  messages         Message[]
  tickets          Ticket[]
  announcements    Announcement[]
  paymentTemplates PaymentTemplate[]

  // Индекс для запросов владельца
  @@index([userId, status])
  @@map("properties")
}

enum PropertyStatus {
  VACANT
  OCCUPIED
  RESERVED
}

// ============== ЖИЛЬЦЫ ==============

model Tenant {
  id           String    @id @default(uuid())
  userId       String    // Владелец, который добавил жильца
  propertyId   String?
  tenantUserId String?   @unique // Аккаунт жильца (если зарегистрировался)
  firstName    String
  lastName     String
  email        String?
  phone        String?

  // НОВОЕ: Универсальный национальный ID (вместо только PESEL)
  nationalId     String? // Значение: "12345678901"
  nationalIdType String? // Тип: "PESEL" | "INN" | "Steuer-ID" | "Rodné číslo" | etc.

  // DEPRECATED: Оставлено для обратной совместимости
  // После миграции данных можно удалить
  pesel String? // @deprecated - используйте nationalId + nationalIdType

  // НОВОЕ: Региональные настройки
  regionCode String @default("PL")

  // НОВОЕ: Экстренный контакт
  emergencyContact String? // ФИО контактного лица
  emergencyPhone   String? // Телефон экстренного контакта

  // Даты аренды
  moveInDate  DateTime?
  moveOutDate DateTime?
  isActive    Boolean   @default(true)

  // НОВОЕ: Лицензионное соглашение
  termsAcceptedAt         DateTime? // Когда принято соглашение
  termsVersion            String?   // Версия соглашения
  registrationCompletedAt DateTime? // Когда завершена полная регистрация

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Связи
  user          User      @relation("OwnerTenants", fields: [userId], references: [id], onDelete: Cascade)
  tenantUser    User?     @relation("TenantUser", fields: [tenantUserId], references: [id], onDelete: SetNull)
  property      Property? @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  payments      Payment[]
  contracts     Contract[]
  meterReadings MeterReading[]

  // Индексы
  @@index([email])
  @@index([userId, isActive])
  @@index([tenantUserId])
  @@index([regionCode])
  @@map("tenants")
}

// ============== ДОГОВОРЫ ==============

model Contract {
  id            String         @id @default(uuid())
  propertyId    String
  tenantId      String
  type          ContractType   @default(STANDARD)
  startDate     DateTime
  endDate       DateTime?
  rentAmount    Float
  depositAmount Float?
  paymentDay    Int            @default(10) // 1-28
  status        ContractStatus @default(ACTIVE)
  notes         String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  // Связи
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Индексы
  @@index([status, endDate])
  @@index([propertyId, status])
  @@map("contracts")
}

enum ContractType {
  STANDARD
  OCCASIONAL
  INSTITUTIONAL
}

enum ContractStatus {
  DRAFT
  ACTIVE
  EXPIRED
  TERMINATED
}

// ============== ПЛАТЕЖИ ==============

model Payment {
  id          String        @id @default(uuid())
  userId      String        // Владелец
  tenantId    String
  amount      Float
  type        PaymentType
  status      PaymentStatus @default(PENDING)
  dueDate     DateTime
  paidDate    DateTime?
  period      String?
  notes       String?

  // Данные для подтверждения
  markedPaidAt    DateTime? // Когда жилец нажал "Я оплатил"
  confirmedAt     DateTime? // Когда владелец подтвердил
  rejectedAt      DateTime? // Когда владелец отклонил
  rejectionReason String?   // Причина отклонения

  // Stripe
  stripePaymentId String? // ID платежа в Stripe

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Связи
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Индексы
  @@index([status, dueDate])
  @@index([tenantId, status])
  @@index([userId, createdAt])
  @@map("payments")
}

enum PaymentType {
  RENT
  UTILITIES
  DEPOSIT
  OTHER
}

enum PaymentStatus {
  PENDING              // Ожидает оплаты
  PENDING_CONFIRMATION // Жилец отметил оплату, ждёт подтверждения
  PAID                 // Подтверждено/Оплачено
  OVERDUE              // Просрочено
  REJECTED             // Отклонено владельцем
  CANCELLED            // Отменено
}

// ============== ШАБЛОНЫ ПЛАТЕЖЕЙ ==============

model PaymentTemplate {
  id            String      @id @default(uuid())
  propertyId    String
  tenantId      String
  amount        Float
  type          PaymentType
  dayOfMonth    Int         @default(1)  // День создания платежа
  dueDayOfMonth Int         @default(10) // День оплаты
  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Связи
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@map("payment_templates")
}

// ============== СООБЩЕНИЯ ==============

model Message {
  id         String    @id @default(uuid())
  senderId   String
  receiverId String
  propertyId String    // Контекст - к какой квартире относится
  content    String
  isRead     Boolean   @default(false)
  readAt     DateTime?
  createdAt  DateTime  @default(now())

  // Связи
  sender   User     @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User     @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  // Индексы
  @@index([receiverId, isRead])
  @@index([propertyId, createdAt])
  @@map("messages")
}

// ============== ЗАЯВКИ (ТИКЕТЫ) ==============

model Ticket {
  id          String       @id @default(uuid())
  propertyId  String
  createdById String       // Кто создал (жилец)
  title       String
  description String
  status      TicketStatus @default(NEW)
  photos      String[]     // URLs фотографий
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Связи
  property  Property        @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  createdBy User            @relation(fields: [createdById], references: [id], onDelete: Cascade)
  comments  TicketComment[]

  @@map("tickets")
}

enum TicketStatus {
  NEW         // Новая
  IN_PROGRESS // В работе
  RESOLVED    // Решена
  CLOSED      // Закрыта
}

model TicketComment {
  id        String   @id @default(uuid())
  ticketId  String
  authorId  String
  content   String
  createdAt DateTime @default(now())

  // Связи
  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@map("ticket_comments")
}

// ============== ОБЪЯВЛЕНИЯ ==============

model Announcement {
  id          String    @id @default(uuid())
  propertyId  String
  createdById String    // Владелец
  title       String
  content     String
  eventDate   DateTime? // Дата события (если есть)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Связи
  property  Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  createdBy User     @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@map("announcements")
}

// ============== СЧЁТЧИКИ (MEDIA) ==============

model Meter {
  id           String         @id @default(uuid())
  propertyId   String
  type         MeterType
  meterNumber  String?
  unit         String
  pricePerUnit Float?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  // Связи
  property Property       @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  readings MeterReading[]

  @@map("meters")
}

enum MeterType {
  ELECTRICITY
  GAS
  WATER_COLD
  WATER_HOT
  HEATING
}

model MeterReading {
  id          String   @id @default(uuid())
  meterId     String
  tenantId    String?
  value       Float
  readingDate DateTime
  photoUrl    String?
  createdAt   DateTime @default(now())

  // Связи
  meter  Meter   @relation(fields: [meterId], references: [id], onDelete: Cascade)
  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: SetNull)

  @@map("meter_readings")
}
