// prisma/schema.prisma
// Flatro — Полная актуальная схема БД
// Обновлено: V9 — Contract Lifecycle (Protocol + ContractAnnex)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ╔══════════════════════════════════════════════════════════════╗
// ║  ПОЛЬЗОВАТЕЛИ                                                ║
// ╚══════════════════════════════════════════════════════════════╝

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  firstName String?
  lastName  String?
  phone     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Роли
  isOwner  Boolean @default(false)
  isTenant Boolean @default(false)

  // Региональные настройки
  regionCode String @default("PL")
  language   String @default("pl")
  timezone   String @default("Europe/Warsaw")

  // Лицензионное соглашение
  termsAcceptedAt   DateTime?
  privacyAcceptedAt DateTime?
  termsVersion      String?

  // V4: Адрес владельца (для договоров)
  address    String?
  city       String?
  postalCode String?

  // V4: Национальный ID владельца
  nationalId     String?
  nationalIdType String? @default("PESEL")

  // Банковские реквизиты
  bankName      String?
  iban          String?
  accountHolder String?

  // Stripe Connect
  stripeAccountId String?
  stripeOnboarded Boolean @default(false)

  subscriptionPlan     SubscriptionPlan @default(FREE)
  stripeCustomerId     String?          @unique
  stripeSubscriptionId String?
  properties Property[]
  tenants    Tenant[]   @relation("OwnerTenants")
  payments   Payment[]

  // Relations — TENANT
  tenantProfile Tenant? @relation("TenantUser")

  // Сообщения
  sentMessages     Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")

  // Прочее
  tickets       Ticket[]
  announcements Announcement[]

  // V6: Zgłoszenia (Issues)
  issues Issue[]

  // V7: Настройки уведомлений и лог
  settings         UserSettings?
  notificationLogs NotificationLog[]

  @@map("users")
}

// ╔══════════════════════════════════════════════════════════════╗
// ║  ПРИГЛАШЕНИЯ                                                 ║
// ╚══════════════════════════════════════════════════════════════╝

model Invitation {
  id         String           @id @default(uuid())
  propertyId String
  email      String?
  code       String           @unique
  status     InvitationStatus @default(PENDING)
  expiresAt  DateTime
  usedAt     DateTime?
  usedBy     String?
  tenantId   String?
  createdAt  DateTime         @default(now())

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([code])
  @@index([expiresAt])
  @@index([propertyId, status])
  @@map("invitations")
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

enum SubscriptionPlan {
  FREE
  PRO
  BUSINESS
}

// ╔══════════════════════════════════════════════════════════════╗
// ║  НЕДВИЖИМОСТЬ                                                ║
// ╚══════════════════════════════════════════════════════════════╝

model Property {
  id          String         @id @default(uuid())
  userId      String
  name        String
  address     String
  city        String
  postalCode  String?
  country     String         @default("Poland")
  area        Float?
  rooms       Int?
  floor       Int?
  description String?
  photos      String[]       @default([])
  status      PropertyStatus @default(VACANT)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  user             User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenants          Tenant[]
  meters           Meter[]
  contracts        Contract[]
  invitations      Invitation[]
  messages         Message[]
  tickets          Ticket[]
  announcements    Announcement[]
  paymentTemplates PaymentTemplate[]

  // V5: Utilities
  fixedUtilities FixedUtility[]
  utilityRates   UtilityRate[]
  settlements    UtilitySettlement[]
  ledgerEntries  TenantLedger[]

  // V6: Issues
  issues Issue[]

  @@index([userId, status])
  @@map("properties")
}

enum PropertyStatus {
  VACANT
  OCCUPIED
  RESERVED
}

// ╔══════════════════════════════════════════════════════════════╗
// ║  ЖИЛЬЦЫ                                                      ║
// ╚══════════════════════════════════════════════════════════════╝

model Tenant {
  id           String  @id @default(uuid())
  userId       String
  propertyId   String?
  tenantUserId String? @unique
  firstName    String
  lastName     String
  email        String?
  phone        String?

  nationalId     String?
  nationalIdType String?

  // @deprecated — используйте nationalId + nationalIdType
  pesel String?

  regionCode String @default("PL")

  emergencyContact String?
  emergencyPhone   String?

  // Польские требования (Contracts V2)
  citizenship         String?
  registrationAddress String?

  moveInDate  DateTime?
  moveOutDate DateTime?
  isActive    Boolean   @default(true)

  termsAcceptedAt         DateTime?
  termsVersion            String?
  registrationCompletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user          User      @relation("OwnerTenants", fields: [userId], references: [id], onDelete: Cascade)
  tenantUser    User?     @relation("TenantUser", fields: [tenantUserId], references: [id], onDelete: SetNull)
  property      Property? @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  payments      Payment[]
  contracts     Contract[]
  meterReadings MeterReading[]

  // V5: Utilities
  settlementShares SettlementShare[]
  ledgerEntries    TenantLedger[]

  @@index([email])
  @@index([userId, isActive])
  @@index([tenantUserId])
  @@index([regionCode])
  @@map("tenants")
}

// ╔══════════════════════════════════════════════════════════════╗
// ║  ДОГОВОРЫ (Contracts V4 + V9 Lifecycle)                      ║
// ╚══════════════════════════════════════════════════════════════╝

model Contract {
  id         String       @id @default(uuid())
  propertyId String
  tenantId   String
  type       ContractType @default(STANDARD)
  startDate  DateTime
  endDate    DateTime?

  // Финансы
  rentAmount       Float
  adminFee         Float  @default(0)
  utilitiesAdvance Float  @default(0)
  depositAmount    Float?
  paymentDay       Int    @default(10)

  // Статус и подпись
  status         ContractStatus @default(DRAFT)
  signedAt       DateTime?
  signedByTenant Boolean        @default(false)
  signedByOwner  Boolean        @default(false)

  // V3: Таймстемпы подписей
  ownerSignedAt  DateTime? @map("owner_signed_at")
  tenantSignedAt DateTime? @map("tenant_signed_at")

  // V3: Отслеживание статуса
  statusUpdatedAt DateTime? @default(now()) @map("status_updated_at")
  statusUpdatedBy String?   @map("status_updated_by")

  // V4: Юридические поля
  noticePeriod    Int?    @default(1)
  additionalTerms String?

  contractSource  String  @default("FORM")
  contractFileUrl String?

  // Najem okazjonalny — lokal zastępczy
  substituteAddress    String?
  substituteCity       String?
  substitutePostalCode String?

  currency String @default("PLN")
  country  String @default("PL")
  locale   String @default("pl-PL")

  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  property      Property               @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  tenant        Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  attachments   ContractAttachment[]
  statusHistory ContractStatusHistory[]

  // V9: Contract Lifecycle
  protocols Protocol[]
  annexes   ContractAnnex[]

  @@index([status, endDate])
  @@index([propertyId, status])
  @@index([tenantId])
  @@index([country])
  @@index([contractSource])
  @@map("contracts")
}

model ContractStatusHistory {
  id         String   @id @default(uuid())
  contractId String   @map("contract_id")
  oldStatus  String?  @map("old_status")
  newStatus  String   @map("new_status")
  changedBy  String   @map("changed_by")
  changedAt  DateTime @default(now()) @map("changed_at")
  reason     String?

  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([contractId, changedAt(sort: Desc)])
  @@index([changedBy])
  @@map("contract_status_history")
}

model ContractAttachment {
  id         String   @id @default(uuid())
  contractId String
  type       String
  label      String
  fileUrl    String
  fileName   String?
  fileSize   Int?
  mimeType   String?
  metadata   Json?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([contractId])
  @@map("contract_attachments")
}

enum ContractType {
  STANDARD
  OCCASIONAL
  INSTITUTIONAL
}

enum ContractStatus {
  DRAFT
  PENDING_SIGNATURE
  SIGNED
  ACTIVE
  EXPIRED
  TERMINATED
}

// ╔══════════════════════════════════════════════════════════════╗
// ║  V9: HANDOVER PROTOCOLS (Protokół zdawczo-odbiorczy)         ║
// ╚══════════════════════════════════════════════════════════════╝

enum ProtocolType {
  MOVE_IN
  MOVE_OUT
}

model Protocol {
  id         String       @id @default(uuid())
  contractId String       @map("contract_id")
  type       ProtocolType
  date       DateTime

  // JSONB: Array of { meterId, meterNumber, meterType, value }
  meterReadings Json @default("[]") @map("meter_readings")

  // JSONB: Array of { type, count, description }
  keysHandedOver Json @default("[]") @map("keys_handed_over")

  // JSONB: Array of { roomName, items: [{ name, condition, notes }] }
  roomsCondition Json @default("[]") @map("rooms_condition")

  // Uwagi ogólne
  generalNotes String? @map("general_notes")

  // JSONB: Array of { url, caption?, roomName? }
  photos Json @default("[]")

  // PDF file reference (Supabase storage path)
  pdfUrl String? @map("pdf_url")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([contractId, type])
  @@index([contractId, date(sort: Desc)])
  @@map("protocols")
}

// ╔══════════════════════════════════════════════════════════════╗
// ║  V9: CONTRACT ANNEXES (Aneksy do umów)                       ║
// ╚══════════════════════════════════════════════════════════════╝

enum AnnexType {
  RENT_CHANGE
  EXTENSION
  OTHER
}

enum AnnexStatus {
  DRAFT
  SIGNED
}

model ContractAnnex {
  id            String      @id @default(uuid())
  contractId    String      @map("contract_id")
  annexNumber   Int         @map("annex_number")
  type          AnnexType
  status        AnnexStatus @default(DRAFT)
  effectiveDate DateTime    @map("effective_date")

  // JSONB audit trail: depends on type
  // RENT_CHANGE: { previousRent, newRent }
  // EXTENSION:   { previousEndDate, newEndDate }
  // OTHER:       {}
  changes Json @default("{}")

  // Free-text clause for OTHER or additional terms
  customText String? @map("custom_text")

  // PDF file reference
  pdfUrl String? @map("pdf_url")

  signedAt DateTime? @map("signed_at")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@unique([contractId, annexNumber])
  @@index([contractId, status])
  @@index([contractId, effectiveDate(sort: Desc)])
  @@map("contract_annexes")
}

// ╔══════════════════════════════════════════════════════════════╗
// ║  ПЛАТЕЖИ                                                     ║
// ╚══════════════════════════════════════════════════════════════╝

model Payment {
  id          String        @id @default(uuid())
  userId      String
  tenantId    String
  amount      Float
  type        PaymentType
  status      PaymentStatus @default(PENDING)
  dueDate     DateTime
  paidDate    DateTime?
  period      String?
  notes       String?

  markedPaidAt    DateTime?
  confirmedAt     DateTime?
  rejectedAt      DateTime?
  rejectionReason String?

  stripePaymentId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([status, dueDate])
  @@index([tenantId, status])
  @@index([userId, createdAt])
  @@map("payments")
}

enum PaymentType {
  RENT
  UTILITIES
  DEPOSIT
  OTHER
}

enum PaymentStatus {
  PENDING
  PENDING_CONFIRMATION
  PAID
  OVERDUE
  REJECTED
  CANCELLED
}

model PaymentTemplate {
  id            String      @id @default(uuid())
  propertyId    String
  tenantId      String
  amount        Float
  type          PaymentType
  dayOfMonth    Int         @default(1)
  dueDayOfMonth Int         @default(10)
  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@map("payment_templates")
}

// ╔══════════════════════════════════════════════════════════════╗
// ║  СООБЩЕНИЯ (V6: Attachments + Issue Reference)               ║
// ╚══════════════════════════════════════════════════════════════╝

model Message {
  id         String    @id @default(uuid())
  senderId   String
  receiverId String
  propertyId String
  content    String?
  isRead     Boolean   @default(false)
  readAt     DateTime?
  createdAt  DateTime  @default(now())

  // V6: Вложения (фото в чате)
  attachmentPath     String?
  attachmentMetadata Json?

  // V6: Ссылка на zgłoszenie
  issueId String?

  sender   User     @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User     @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  issue    Issue?   @relation(fields: [issueId], references: [id], onDelete: SetNull)

  @@index([receiverId, isRead])
  @@index([propertyId, createdAt])
  @@index([issueId])
  @@map("messages")
}

// ╔══════════════════════════════════════════════════════════════╗
// ║  ЗАЯВКИ — legacy (Tickets)                                   ║
// ╚══════════════════════════════════════════════════════════════╝

model Ticket {
  id          String       @id @default(uuid())
  propertyId  String
  createdById String
  title       String
  description String
  status      TicketStatus @default(NEW)
  photos      String[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  property  Property        @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  createdBy User            @relation(fields: [createdById], references: [id], onDelete: Cascade)
  comments  TicketComment[]

  @@map("tickets")
}

enum TicketStatus {
  NEW
  IN_PROGRESS
  RESOLVED
  CLOSED
}

model TicketComment {
  id        String   @id @default(uuid())
  ticketId  String
  authorId  String
  content   String
  createdAt DateTime @default(now())

  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@map("ticket_comments")
}

// ╔══════════════════════════════════════════════════════════════╗
// ║  ОБЪЯВЛЕНИЯ                                                  ║
// ╚══════════════════════════════════════════════════════════════╝

model Announcement {
  id          String    @id @default(uuid())
  propertyId  String
  createdById String
  title       String
  content     String
  eventDate   DateTime?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  property  Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  createdBy User     @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@map("announcements")
}

// ╔══════════════════════════════════════════════════════════════╗
// ║  V6: ISSUES (ZGŁOSZENIA) + ATTACHMENTS                       ║
// ╚══════════════════════════════════════════════════════════════╝

model Issue {
  id          String        @id @default(uuid())
  propertyId  String
  createdById String
  title       String
  description String
  category    IssueCategory @default(OTHER)
  status      IssueStatus   @default(OPEN)
  priority    IssuePriority @default(MEDIUM)
  isPrivate   Boolean       @default(false)
  isDeleted   Boolean       @default(false)

  resolvedAt DateTime?
  closedAt   DateTime?
  deletedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  property    Property          @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  createdBy   User              @relation(fields: [createdById], references: [id], onDelete: Cascade)
  attachments IssueAttachment[]
  messages    Message[]

  @@index([propertyId, status])
  @@index([createdById])
  @@index([propertyId, isPrivate, isDeleted])
  @@map("issues")
}

model IssueAttachment {
  id        String   @id @default(uuid())
  issueId   String
  filePath  String
  fileName  String
  fileSize  Int?
  mimeType  String?
  metadata  Json?
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())

  issue Issue @relation(fields: [issueId], references: [id], onDelete: Cascade)

  @@index([issueId])
  @@map("issue_attachments")
}

enum IssueStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum IssueCategory {
  PLUMBING
  ELECTRICAL
  HEATING
  APPLIANCE
  STRUCTURAL
  PEST_CONTROL
  CLEANING
  OTHER
}

enum IssuePriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// ╔══════════════════════════════════════════════════════════════╗
// ║  V5: METERS & UTILITIES MODULE                               ║
// ╚══════════════════════════════════════════════════════════════╝

model Meter {
  id           String      @id @default(uuid())
  propertyId   String
  type         MeterType
  meterNumber  String?
  serialNumber String?
  unit         String
  pricePerUnit Float?

  status      MeterStatus @default(ACTIVE)
  installDate DateTime?
  archiveDate DateTime?
  archiveNote String?

  // Meter exchange chain
  replacedById String? @unique
  replacedBy   Meter?  @relation("MeterReplacement", fields: [replacedById], references: [id])
  replaces     Meter?  @relation("MeterReplacement")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  property        Property         @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  readings        MeterReading[]
  settlementItems SettlementItem[]

  @@index([propertyId, status])
  @@index([propertyId, type])
  @@map("meters")
}

enum MeterType {
  ELECTRICITY
  GAS
  WATER_COLD
  WATER_HOT
  HEATING
}

enum MeterStatus {
  ACTIVE
  ARCHIVED
  DECOMMISSIONED
}

model MeterReading {
  id          String           @id @default(uuid())
  meterId     String
  tenantId    String?
  value       Float
  readingDate DateTime
  readingType MeterReadingType @default(REGULAR)
  photoUrl    String?
  notes       String?
  createdAt   DateTime         @default(now())

  meter  Meter   @relation(fields: [meterId], references: [id], onDelete: Cascade)
  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: SetNull)

  @@index([meterId, readingDate(sort: Desc)])
  @@index([readingType])
  @@map("meter_readings")
}

enum MeterReadingType {
  REGULAR
  INITIAL
  FINAL
  METER_EXCHANGE
}

model FixedUtility {
  id          String           @id @default(uuid())
  propertyId  String
  type        FixedUtilityType
  name        String
  periodCost  Float
  splitMethod CostSplitMethod  @default(BY_DAYS)
  isPerPerson Boolean          @default(false)
  isActive    Boolean          @default(true)
  notes       String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  property Property         @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  items    SettlementItem[]

  @@index([propertyId, isActive])
  @@map("fixed_utilities")
}

enum FixedUtilityType {
  INTERNET
  GARBAGE
  ADMIN_FEE
  PARKING
  TV_CABLE
  SECURITY
  ELEVATOR
  OTHER
}

model UtilityRate {
  id            String    @id @default(uuid())
  propertyId    String
  meterType     MeterType
  pricePerUnit  Float
  effectiveFrom DateTime
  effectiveTo   DateTime?
  source        String?
  notes         String?
  createdAt     DateTime  @default(now())

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId, meterType, effectiveFrom(sort: Desc)])
  @@map("utility_rates")
}

model UtilitySettlement {
  id             String           @id @default(uuid())
  propertyId     String
  createdById    String
  periodStart    DateTime
  periodEnd      DateTime
  title          String?
  approach       BillingApproach  @default(MONTHLY)
  totalAmount    Float            @default(0)
  invoiceNumber  String?
  invoiceDate    DateTime?
  invoiceFileUrl String?
  status         SettlementStatus @default(DRAFT)
  finalizedAt    DateTime?
  voidedAt       DateTime?
  voidReason     String?
  notes          String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  property Property          @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  items    SettlementItem[]
  shares   SettlementShare[]

  @@index([propertyId, periodStart(sort: Desc)])
  @@index([status])
  @@map("utility_settlements")
}

enum SettlementStatus {
  DRAFT
  CALCULATED
  FINALIZED
  VOIDED
}

enum BillingApproach {
  MONTHLY
  QUARTERLY
  SEMI_ANNUAL
  ANNUAL
  ADVANCE_PAYMENT
}

model SettlementItem {
  id             String          @id @default(uuid())
  settlementId   String
  meterId        String?
  fixedUtilityId String?
  utilityLabel   String
  unitLabel      String?
  prevReading    Float?
  currReading    Float?
  consumption    Float?
  snapshotRate   Float?
  periodCost     Float?
  totalCost      Float
  splitMethod    CostSplitMethod @default(BY_DAYS)
  createdAt      DateTime        @default(now())

  settlement   UtilitySettlement @relation(fields: [settlementId], references: [id], onDelete: Cascade)
  meter        Meter?            @relation(fields: [meterId], references: [id], onDelete: SetNull)
  fixedUtility FixedUtility?     @relation(fields: [fixedUtilityId], references: [id], onDelete: SetNull)

  @@index([settlementId])
  @@map("settlement_items")
}

enum CostSplitMethod {
  BY_DAYS
  BY_PERSONS
  EQUAL
  MANUAL
}

model SettlementShare {
  id               String    @id @default(uuid())
  settlementId     String
  tenantId         String
  activeDays       Int
  totalDays        Int
  shareRatio       Float
  calculatedAmount Float
  adjustedAmount   Float?
  finalAmount      Float
  advancesPaid     Float     @default(0)
  balanceDue       Float     @default(0)
  isPaid           Boolean   @default(false)
  paidAt           DateTime?
  paymentId        String?
  notes            String?
  ownerNotes       String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  settlement UtilitySettlement @relation(fields: [settlementId], references: [id], onDelete: Cascade)
  tenant     Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([settlementId, tenantId])
  @@index([tenantId, createdAt(sort: Desc)])
  @@index([isPaid])
  @@map("settlement_shares")
}

model TenantLedger {
  id           String          @id @default(uuid())
  tenantId     String
  propertyId   String
  entryType    LedgerEntryType
  amount       Float
  settlementId String?
  paymentId    String?
  description  String
  balanceAfter Float
  createdAt    DateTime        @default(now())

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([tenantId, createdAt(sort: Desc)])
  @@index([propertyId, tenantId])
  @@map("tenant_ledger")
}

enum LedgerEntryType {
  CHARGE
  ADVANCE_PAYMENT
  PAYMENT
  ADJUSTMENT
  CARRY_FORWARD
}

// ╔══════════════════════════════════════════════════════════════╗
// ║  V7: EMAIL NOTIFICATIONS                                     ║
// ╚══════════════════════════════════════════════════════════════╝

model UserSettings {
  id     String @id @default(uuid())
  userId String @unique

  emailPaymentReminders Boolean @default(true)
  emailContractExpiry   Boolean @default(true)
  emailNewTenant        Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}

model NotificationLog {
  id     String @id @default(uuid())
  userId String

  type      NotificationType
  status    NotificationStatus @default(PENDING)
  recipient String
  subject   String
  body      String             @db.Text

  relatedId   String?
  relatedType String?

  sentAt     DateTime?
  errorMsg   String?
  externalId String?

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt(sort: Desc)])
  @@index([type, status])
  @@index([relatedId, relatedType])
  @@map("notification_logs")
}

enum NotificationType {
  PAYMENT_DUE_SOON
  PAYMENT_OVERDUE
  CONTRACT_EXPIRY_SOON
  CONTRACT_EXPIRED
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
  SKIPPED
}
